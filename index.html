<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dana — PO/Contract Wizard (v5.5)</title>

 <!-- libs (LOCAL copies; no CDN dependency) -->
<script src="./libs/pizzip.min.js"></script>
<script src="./libs/pizzip-utils.min.js"></script>
<script src="./libs/docxtemplater.js"></script>
<script src="./libs/mammoth.browser.min.js"></script>
<script>
  function getDocxCtor() {
    return window.docxtemplater || null;
  }
  function getZipCtor() {
    return window.PizZip || null;
  }
  async function waitDocxLibs() {
    const t0 = performance.now();
    while (!(getZipCtor() && getDocxCtor())) {
      if (performance.now() - t0 > 8000) {
        throw new Error('کتابخانه‌های Docxtemplater/PizZip بارگذاری نشدند.');
      }
      await new Promise(r => setTimeout(r, 50));
    }
  }
  async function waitMammoth() {
    for (let i = 0; i < 100 && !window.mammoth; i++) {
      await new Promise(r => setTimeout(r, 100));
    }
    if (!window.mammoth) throw new Error('کتابخانه Mammoth بارگذاری نشد.');
  }
</script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <!-- Supabase for optional backend integration (requires window.SUPABASE_URL & window.SUPABASE_KEY) -->
  <!-- Dynamically load the Supabase library only when keys are provided. If the CDN fails or keys are absent, fall back to offline mode. -->
  <script>
    (function () {
      const url = (window.SUPABASE_URL || '').trim();
      const key = (window.SUPABASE_KEY || '').trim();
      if (url && key) {
        const s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js';
        s.async = true;
        s.onerror = () => {
          console.warn('Supabase CDN failed to load — running in offline mode.');
        };
        document.head.appendChild(s);
      } else {
        console.info('Supabase keys not provided — running in offline/localStorage mode.');
      }
    })();
  </script>
  <!-- Local API helper (handles auth, history, notifications) -->
  <script src="api.js"></script>

  <style>
  :root {
    --bg: #f8fafc;
    --panel: #ffffff;
    --text: #1e293b;
    --muted: #64748b;
    --primary: #2563eb;
    --primary-light: #eff6ff;
    --primary-dark: #1d4ed8;
    --ok: #10b981;
    --warn: #f59e0b;
    --error: #ef4444;
    --border: #e2e8f0;
    --chip: #f1f5f9;
    --radius: 12px;
    --shadow: 0 4px 12px -2px rgba(0,0,0,.08);
    --shadow-lg: 0 10px 25px -5px rgba(0,0,0,.1);
    --font-fa: "Vazirmatn", Tahoma, Arial, sans-serif;
    --transition: all 0.2s ease;
    /* Guest/Skip modes kill-switches */
    /* hide auth modal completely when guest or skip mode is active */
    html.guest-mode #authModal,
    html.skip-mode #authModal { display: none !important; }
    /* hide sign-in button only in guest mode */
    html.guest-mode #signInBtn { display: none !important; }
    /* disable pointer events for disabled link buttons */
    .btn.link.disabled { opacity: .45; pointer-events: none; }
  }

  body.dark {
    --bg: #0f172a;
    --panel: #1e293b;
    --text: #f1f5f9;
    --muted: #94a3b8;
    --primary: #60a5fa;
    --primary-light: #1e3a8a;
    --primary-dark: #3b82f6;
    --border: #334155;
    --chip: #334155;
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    margin: 0;
    font-family: var(--font-fa);
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    transition: var(--transition);
  }

  h2 {
    font-size: 24px;
    margin: 0 0 20px;
    font-weight: 700;
  }

  h3 {
    font-size: 18px;
    margin: 0 0 16px;
    font-weight: 600;
  }

  h4 {
    font-size: 16px;
    margin: 0 0 8px;
    font-weight: 600;
  }

  .hidden {
    display: none;
  }

  /* Ensure modals respect the hidden class. Without this, the later .modal rule overrides display and the modal remains visible */
  .modal.hidden {
    display: none !important;
  }

  .mt-16 {
    margin-top: 16px;
  }

  .mt-8 {
    margin-top: 8px;
  }

  /* Utility buttons */
  .btn.link {
    background: transparent;
    border: none;
    color: var(--primary);
    cursor: pointer;
    padding: 8px;
    font-size: 14px;
    transition: var(--transition);
  }
  .btn.link:hover {
    text-decoration: underline;
  }
  .btn.ok {
    background: var(--ok);
    color: #fff;
  }
  .btn.ok:hover {
    background: #0f9d58;
  }
  .btn.small {
    font-size: 12px;
    padding: 4px 8px;
  }

  /* Alert box for preview errors */
  .alert {
    background: var(--error);
    color: #fff;
    border-radius: var(--radius);
    padding: 10px 12px;
    margin-bottom: 12px;
    white-space: pre-line;
  }

  /* Modal for authentication */
  .modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
  }
  .modal-content {
    background: var(--panel);
    padding: 24px;
    border-radius: var(--radius);
    box-shadow: var(--shadow-lg);
    width: 90%;
    max-width: 400px;
    text-align: center;
  }
  .modal-content h3 {
    margin-bottom: 16px;
  }
  .modal-content input {
    width: 100%;
    padding: 8px 10px;
    margin-bottom: 12px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    font-size: 14px;
  }
  .modal-content .row {
    display: flex;
    gap: 8px;
    justify-content: center;
    margin-top: 8px;
  }
  .modal-content .error {
    color: var(--error);
    margin-top: 8px;
    font-size: 13px;
  }

  /* Notification bell */
  .notif-bell {
    position: relative;
    cursor: pointer;
    margin-left: 8px;
    display: flex;
    align-items: center;
    font-size: 18px;
  }
  .notif-bell .count {
    position: absolute;
    top: -6px;
    left: -6px;
    background: var(--error);
    color: #fff;
    border-radius: 8px;
    padding: 0 4px;
    font-size: 10px;
    line-height: 12px;
  }

  /* User menu */
  .user-menu {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-left: 8px;
  }
  .user-menu .user-email {
    font-size: 14px;
    color: var(--primary-dark);
  }

  /* History page */
  #historyPage {
    max-width: 1200px;
    margin: 0 auto;
    padding: 24px;
  }
  .history-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 16px;
  }
  .history-table th, .history-table td {
    border: 1px solid var(--border);
    padding: 8px;
    text-align: center;
    font-size: 14px;
  }
  .history-table th {
    background: var(--chip);
  }
  .history-table td.actions {
    display: flex;
    gap: 4px;
    justify-content: center;
  }
  
  .mb-16 {
    margin-bottom: 16px;
  }
  
  .mb-8 {
    margin-bottom: 8px;
  }
  
  /* Header */
  header {
    position: sticky;
    top: 0;
    z-index: 20;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 24px;
    background: rgba(255,255,255,.85);
    backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border);
    transition: var(--transition);
  }
  
  body.dark header {
    background: rgba(30, 41, 59, .85);
  }
  
  .brand {
    display: flex;
    align-items: center;
    gap: 12px;
    font-weight: 700;
    font-size: 18px;
  }
  
  .logo {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    background: linear-gradient(135deg, #60a5fa, #34d399);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 14px;
  }
  
  .toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    padding: 8px;
    border-radius: var(--radius);
    background: var(--chip);
    transition: var(--transition);
  }
  
  .toggle:hover {
    background: var(--border);
  }
  
  .toggle input {
    display: none;
  }
  
  .toggle span {
    font-size: 18px;
  }
  
  /* Stepper */
  .stepper {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin: 16px auto 24px;
    max-width: 1200px;
    padding: 0 16px;
  }
  
  .step {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 18px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--panel);
    color: var(--muted);
    flex: 1;
    min-width: 140px;
    justify-content: center;
    transition: var(--transition);
    cursor: pointer;
  }
  
  .step:hover {
    border-color: var(--primary);
    color: var(--primary);
  }
  
  .step.active {
    background: linear-gradient(135deg, var(--primary), #60a5fa);
    color: #fff;
    border-color: transparent;
    box-shadow: 0 6px 20px -4px rgba(37, 99, 235, 0.4);
  }
  
  .step span {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: #eef2ff;
    color: #1d4ed8;
    display: grid;
    place-items: center;
    font-size: 12px;
    font-weight: 600;
  }
  
  body.dark .step span {
    background: #1b223c;
    color: #93c5fd;
  }
  
  .step.active span {
    background: rgba(255,255,255,0.2);
    color: white;
  }
  
  /* Container */
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 16px 40px;
  }
  
  /* Cards */
  .cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 16px;
  }
  
  .card {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    box-shadow: var(--shadow);
    transition: var(--transition);
  }
  
  .card:hover {
    box-shadow: var(--shadow-lg);
  }
  
  .card.radio {
    cursor: pointer;
  }
  
  .card.radio input {
    display: none;
  }
  
  .card.radio input:checked + .card-content {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }
  
  .card-content {
    padding: 12px;
    border: 2px solid transparent;
    border-radius: var(--radius);
    transition: var(--transition);
  }
  
  /* Grid */
  .grid {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 16px;
  }
  
  .field {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  
  .field.check {
    flex-direction: row;
    align-items: center;
  }
  
  label {
    font-size: 14px;
    color: var(--muted);
    font-weight: 500;
  }
  
  input, select, textarea {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--panel);
    color: var(--text);
    outline: none;
    transition: var(--transition);
    font-family: var(--font-fa);
  }
  
  input:focus, select:focus, textarea:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }
  
  textarea {
    min-height: 120px;
    resize: vertical;
  }
  
  .full {
    grid-column: 1 / -1;
  }
  
  .six {
    grid-column: span 6;
  }
  
  .four {
    grid-column: span 4;
  }
  
  .three {
    grid-column: span 3;
  }
  
  @media (max-width: 980px) {
    .six, .four, .three {
      grid-column: 1 / -1;
    }
  }
  
  /* Table */
  .table-scroll {
    overflow-x: auto;
    border-radius: var(--radius);
    border: 1px solid var(--border);
  }
  
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
  }
  
  th, td {
    border: 1px solid var(--border);
    padding: 10px 12px;
    text-align: center;
  }
  
  th {
    background: var(--primary-light);
    font-weight: 600;
  }
  
  body.dark th {
    background: var(--primary-light);
  }
  
  /* Row */
  .row {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }
  
  .between {
    justify-content: space-between;
  }
  
  /* Chips */
  .chips {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }
  
  .chip {
    padding: 8px 16px;
    border: 1px solid var(--border);
    border-radius: 999px;
    background: var(--chip);
    cursor: pointer;
    user-select: none;
    transition: var(--transition);
    font-size: 14px;
  }
  
  .chip:hover {
    background: var(--border);
  }
  
  .chip.on {
    border-color: var(--primary);
    background: var(--primary-light);
    color: var(--primary);
  }
  
  /* Actions */
  .actions {
    display: flex;
    justify-content: space-between;
    gap: 12px;
    margin-top: 24px;
    position: sticky;
    bottom: 0;
    background: var(--bg);
    padding: 16px 0;
    z-index: 10;
  }
  
  .btn {
    padding: 12px 20px;
    border: none;
    border-radius: var(--radius);
    cursor: pointer;
    font-size: 15px;
    font-weight: 500;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .btn.primary {
    background: linear-gradient(90deg, var(--primary), #60a5fa);
    color: #fff;
    box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
  }
  
  .btn.primary:hover {
    background: linear-gradient(90deg, var(--primary-dark), var(--primary));
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
  }
  
  .btn.secondary {
    background: var(--chip);
    color: var(--text);
    border: 1px solid var(--border);
  }
  
  .btn.secondary:hover {
    background: var(--border);
  }
  
  .btn.warn {
    background: var(--warn);
    color: white;
  }
  
  .btn.warn:hover {
    background: #d97706;
  }
  
  .btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  
  /* Preview */
  .preview-card {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
  }
  
  .preview-card header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    font-weight: 700;
    position: static;
    backdrop-filter: none;
  }
  
  .preview-body {
    padding: 20px;
    min-height: 300px;
    max-height: 500px;
    overflow-y: auto;
  }
  
  /* Upload */
  .upload-box {
    margin-top: 16px;
  }
  
  .upload-box input[type=file] {
    width: 100%;
    padding: 8px;
  }
  
  /* Hint */
  .hint {
    font-size: 13px;
    color: var(--muted);
  }
  
  code {
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size: 12px;
    background: var(--chip);
    padding: 2px 6px;
    border-radius: 4px;
  }
  
  /* Status */
  .status {
    padding: 8px 12px;
    border-radius: var(--radius);
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .status.error {
    background: rgba(239, 68, 68, 0.1);
    color: var(--error);
  }
  
  .status.success {
    background: rgba(16, 185, 129, 0.1);
    color: var(--ok);
  }
  
  /* Badge */
  .badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
  }
  
  .badge.disabled {
    background: var(--chip);
    color: var(--muted);
  }
  
  .badge.warning {
    background: rgba(245, 158, 11, 0.1);
    color: var(--warn);
  }
  
  /* Section */
  .section {
    background: var(--panel);
    border-radius: var(--radius);
    padding: 24px;
    box-shadow: var(--shadow);
    margin-bottom: 24px;
  }
  
  /* Progress bar */
  .progress-bar {
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
    margin: 8px 0 16px;
  }
  
  .progress {
    height: 100%;
    background: linear-gradient(90deg, var(--primary), #60a5fa);
    transition: width 0.3s ease;
  }
  
  /* Template selector */
  .template-option {
    position: relative;
  }
  
  .template-option .badge {
    position: absolute;
    top: 12px;
    left: 12px;
  }
  
  /* Clause options */
  .clause-option {
    margin-bottom: 12px;
  }
  
  .clause-option input[type="radio"] {
    display: none;
  }
  
  .clause-option label {
    display: block;
    padding: 16px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    cursor: pointer;
    transition: var(--transition);
    font-size: 14px;
    line-height: 1.6;
  }
  
  .clause-option input[type="radio"]:checked + label {
    border-color: var(--primary);
    background: var(--primary-light);
  }
  
  .clause-option label:hover {
    border-color: var(--primary);
  }
  
  /* Form group */
  .form-group {
    margin-bottom: 20px;
  }
  
  /* Item row */
  .item-row {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr auto;
    gap: 8px;
    align-items: center;
    padding: 12px;
    border-bottom: 1px solid var(--border);
  }
  
  .item-row:last-child {
    border-bottom: none;
  }
  
  .item-row input {
    padding: 8px 10px;
    font-size: 13px;
  }
  
  /* Attachment row */
  .attachment-row {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr auto;
    gap: 12px;
    align-items: center;
    padding: 12px;
    border-bottom: 1px solid var(--border);
  }
  
  .attachment-row:last-child {
    border-bottom: none;
  }
  
  /* Loading */
  .loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  /* Welcome message */
  .welcome {
    text-align: center;
    padding: 40px 20px;
  }
  
  .welcome-icon {
    font-size: 48px;
    margin-bottom: 16px;
  }
  
  .welcome h2 {
    margin-bottom: 12px;
  }
  
  .welcome p {
    color: var(--muted);
    max-width: 600px;
    margin: 0 auto;
  }
  
  /* Pill */
  .pill {
    padding: 4px 10px;
    border-radius: 999px;
    background: var(--primary-light);
    color: var(--primary);
    font-size: 12px;
    border: 1px solid var(--primary);
    font-weight: 500;
  }
  
  /* Header buttons */
  .header-buttons {
    display: flex;
    gap: 8px;
    align-items: center;
  }
  
  .header-buttons .btn {
    font-size: 14px;
    padding: 8px 12px;
  }
  
  .header-file-input {
    display: none;
  }
  /* Cleaner inputs for items table */
  #itemsTable input {
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 6px 8px;
    width: 100%;
    font-size: 14px;
    transition: border-color .2s;
  }
  #itemsTable input:focus {
    border-color: var(--primary);
    outline: none;
  }
  #itemsTable td {
    padding: 6px 4px;
  }

  /* ----- delivery docs & signatories UI ----- */
  .chips {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 8px;
  }
  .chips .chip {
    padding: 4px 8px;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--chip);
    cursor: pointer;
    transition: var(--transition);
  }
  .chips .chip.selected {
    border-color: #34d399;
    box-shadow: 0 0 0 2px rgba(52,211,153,.2);
  }
  .doc-other {
    margin-top: 8px;
    display: flex;
    gap: 8px;
  }
  .doc-other input {
    flex: 1;
    padding: 6px 8px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--panel);
    color: var(--text);
  }
  #supplierSignWrap > div {
    display: flex;
    gap: 8px;
    margin-top: 8px;
  }
  #supplierSignWrap input {
    flex: 1;
    padding: 6px 8px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--panel);
    color: var(--text);
  }
  .btn.small {
    padding: 4px 8px;
    font-size: 13px;
  }
  /* Uploads layout */
  .upload-group {
    margin-bottom: 12px;
  }
  .upload-group label {
    display: block;
    margin-bottom: 4px;
    font-weight: 600;
  }
  /* Radio group for calendar type */
  .radio-group label {
    margin-right: 12px;
    cursor: pointer;
  }
  /* Delivery docs list */
  .delivery-docs label {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 4px;
  }
  /* Small button */
  .btn.small {
    padding: 4px 8px;
    font-size: 12px;
    margin-top: 8px;
  }
  /* Supplier signatory row */
  .sign-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 6px;
  }
  .sign-row input {
    flex: 1;
    padding: 6px 8px;
    border: 1px solid var(--border);
    border-radius: 6px;
  }
</style>
</head>
<body class="light">
<header>
  <div class="brand">
    <div class="logo">D</div>
    <span>Dana Energy – PO Wizard</span>
  </div>
  <div class="header-buttons">
    <button class="btn secondary" id="exportJson">Export JSON</button>
    <button class="btn secondary" id="importJsonBtn">Import JSON</button>
    <input type="file" id="importJson" accept="application/json" class="header-file-input">
    <label class="toggle">
      <input type="checkbox" id="darkMode">
      <span>🌙</span>
    </label>
    <!-- History navigation and user actions -->
    <button class="btn link" id="historyNav">تاریخچه</button>
    <button class="btn link" id="assignedNav">ارجاع‌ها</button>
    <div class="notif-bell" id="notifBell">
      <span>🔔</span>
      <span id="notifCount" class="count hidden">0</span>
    </div>
    <div id="userMenu" class="user-menu hidden">
      <span id="userEmail" class="user-email"></span>
      <button class="btn small" id="signOutBtn">خروج</button>
    </div>
    <button class="btn primary" id="signInBtn">ورود</button>
  </div>
</header>

<div class="stepper">
  <div class="step active" data-stage="1"><span>۱</span>الگو</div>
  <div class="step" data-stage="2"><span>۲</span>بارگذاری‌ها</div>
  <div class="step" data-stage="3"><span>۳</span>اطلاعات</div>
  <div class="step" data-stage="4"><span>۴</span>بندها</div>
  <div class="step" data-stage="p"><span>۵</span>پیش‌نمایش</div>
</div>

<main class="container">
  <!-- Stage 1 -->
  <section id="stage1" class="stage">
    <div class="section">
      <h2>۱. انتخاب الگو</h2>
      <div class="cards">
        <label class="card radio template-option">
          <input type="radio" name="template" value="po-noban" checked>
          <div class="card-content">
            <h4>PO Draft – Noban</h4>
            <p>برای خرید مستقیم از نوبان دکل</p>
          </div>
        </label>
        <label class="card radio template-option">
          <input type="radio" name="template" value="main-irr" disabled>
          <div class="card-content">
            <h4>قرارداد اصلی (ریالی)</h4>
            <p>در دست ساخت</p>
            <span class="badge disabled">به زودی</span>
          </div>
        </label>
        <label class="card radio template-option">
          <input type="radio" name="template" value="main-fx" disabled>
          <div class="card-content">
            <h4>قرارداد اصلی (ارزی)</h4>
            <p>در دست ساخت</p>
            <span class="badge disabled">به زودی</span>
          </div>
        </label>
      </div>
      
      <div class="form-group mt-16">
        <h3>الگوی اختصاصی</h3>
        <p class="hint mb-8">اگر الگوی اختصاصی دارید اینجا بارگذاری کنید (اختیاری)</p>
        <input type="file" id="templateFile" accept=".docx">
      </div>
    </div>
    
    <div class="actions">
      <span class="hint">اگر فایل الگو ندهید از مسیر <code>template/po-noban.template.docx</code> خوانده می‌شود.</span>
      <button class="btn primary" id="go2" data-go-step="2">
        ادامه
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M10.5 8L6.5 4V12L10.5 8Z" fill="currentColor"/>
        </svg>
      </button>
    </div>
  </section>

  <!-- Stage 2 -->
  <section id="stage2" class="stage hidden">
    <div class="section">
      <h2>۲. بارگذاری‌ها</h2>
      <p class="hint mb-8">فایل‌های زیر را بارگذاری کنید. تنها فایل‌های بارگذاری‌شده به عنوان «پیوست» نمایش داده می‌شوند.</p>
      <div class="upload-group">
        <label>سند اصلی</label>
        <input type="file" id="uploadMainDoc" accept=".pdf,.docx">
      </div>
      <div class="upload-group">
        <label>ارزیابی نهایی / مقایسه</label>
        <input type="file" id="uploadEvalDoc" accept=".pdf,.docx">
      </div>
      <div class="upload-group">
        <label>مصوبه کمیسیون / صورتجلسه</label>
        <input type="file" id="uploadCommissionDoc" accept=".pdf,.docx">
      </div>
      <div class="upload-group">
        <label>پیشنهاد فروشنده (فنی + مالی)</label>
        <input type="file" id="uploadVendorDoc" accept=".pdf,.docx">
      </div>
      <div class="upload-group">
        <label>پیوست‌های دیگر</label>
        <input type="file" id="uploadAdditionalDocs" accept=".pdf,.docx" multiple>
      </div>
    </div>
    <div class="actions">
      <button class="btn secondary" id="back2">بازگشت</button>
      <button class="btn primary" id="go3" data-go-step="3">ادامه
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M10.5 8L6.5 4V12L10.5 8Z" fill="currentColor"/>
        </svg>
      </button>
    </div>
  </section>


  <!-- Stage 3 -->
  <section id="stage3" class="stage hidden">
    <div class="section">
      <h2>۳. اطلاعات تراکنش</h2>
      <div class="progress-bar">
        <!-- progress roughly halfway for stage 3 of 5 -->
        <div class="progress" style="width: 50%"></div>
      </div>
      
      <div class="grid">
        <div class="field three">
          <label>شماره PO/Contract</label>
          <input id="poNumber" placeholder="مثال: PO-2023-001">
        </div>
        <!-- Gregorian date input -->
        <div class="field three cal-greg">
          <label>تاریخ صدور</label>
          <input id="issueDate" type="date">
        </div>
        <div class="field three">
          <label>ارز <span class="pill" id="currencyFaPill">ریال</span></label>
          <select id="currency">
            <option value="IRR">ریال</option>
            <option value="USD">دلار آمریکا</option>
            <option value="EUR">یورو</option>
            <option value="AED">درهم</option>
          </select>
        </div>
        <div class="field three">
          <label>مبلغ بدون VAT</label>
          <!-- Use text input so we can display comma separators while storing numeric value in state -->
          <input id="amount" type="text" placeholder="0">
        </div>

        <div class="field full">
          <label>موضوع خرید</label>
          <input id="subject" placeholder="توضیح مختصر درباره موضوع خرید">
        </div>
        <div class="field full">
          <label>نام پروژه</label>
          <input id="projectName" placeholder="نام پروژه مربوطه">
        </div>

        <div class="field three">
          <label>نام سازنده</label>
          <input id="manufacturerName" placeholder="نام شرکت سازنده">
        </div>
        <div class="field three">
          <label>کشور سازنده</label>
          <input id="manufacturerCountry" placeholder="کشور سازنده">
        </div>
        <div class="field three">
          <label>مهلت تحویل (روز)</label>
          <input id="deliveryDeadlineDays" type="number" min="1" placeholder="30">
        </div>
        <div class="field three">
          <label>مبدأ شمارش تحویل</label>
          <input id="leadtimeTrigger" placeholder="انعقاد قرارداد / واریز پیش‌پرداخت">
        </div>

        <div class="field three check">
          <label><input id="allowBuyerRep" type="checkbox"> اجازهٔ نمایندهٔ خریدار برای تغییر برنامهٔ تحویل</label>
        </div>
        <div class="field three check">
          <label><input id="hasWarranty" type="checkbox"> وجود گارانتی</label>
        </div>
        <div class="field three">
          <label>مدت گارانتی (ماه)</label>
          <input id="warrantyMonths" type="number" min="0" placeholder="12">
        </div>
        <div class="field three check">
          <label><input id="fxSettlement" type="checkbox"> چاپ جملهٔ تسعیر</label>
        </div>

        <div class="field three">
          <label>برچسب منبع نرخ</label>
          <input id="fxRateSourceLabel" placeholder="سایت اعلامی خریدار / tgju.org">
        </div>
        <div class="field three">
          <label>شماره پیشنهاد فروشنده</label>
          <input id="offerNumber" placeholder="شماره پیشنهاد">
        </div>
        <div class="field three">
        <label>تاریخ پیشنهاد فروشنده</label>
          <input id="offerDate" placeholder="۱۴۰۳/۰۷/۱۲ یا 2025-10-04">
        </div>

        <!-- Additional transaction fields -->
        <div class="field three">
          <label>نوع مهلت</label>
          <select id="deadlineType">
            <option value="">انتخاب کنید</option>
            <option value="calendar">تقویمی</option>
            <option value="work">کاری</option>
          </select>
        </div>
        <div class="field three">
          <label>Incoterms 2020</label>
          <select id="incoterms">
            <option value="">انتخاب کنید</option>
            <option value="EXW">EXW</option>
            <option value="FCA">FCA</option>
            <option value="CPT">CPT</option>
            <option value="CIP">CIP</option>
            <option value="DAP">DAP</option>
            <option value="DPU">DPU</option>
            <option value="DDP">DDP</option>
          </select>
        </div>
        <div class="field three">
          <label>نوع تقویم</label>
          <select id="calendarType">
            <option value="gregorian">میلادی</option>
            <option value="jalali">شمسی</option>
          </select>
        </div>
        <div class="field three cal-jalali">
          <label>تاریخ صدور (شمسی)</label>
          <input id="issueDateJalali" placeholder="مثال: ۱۴۰۳/۰۷/۱۲">
        </div>

      </div>
    </div>


    <!-- Items -->
    <div class="section">
      <div class="row between">
        <h3>جدول اقلام</h3>
        <div class="hint">ارز: <b id="currencyFaTag">ریال</b></div>
      </div>
      
      <div class="table-scroll">
        <table id="itemsTable">
          <thead>
            <tr>
              <th>ردیف</th>
              <th>مشخصات فنی</th>
              <th>واحد</th>
              <th>مقدار</th>
              <th>قیمت واحد</th>
              <th>قیمت کل</th>
              <th>عملیات</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <th colspan="5" style="text-align:left">جمع ناخالص</th>
              <th id="totalNetText" style="text-align:left">۰</th>
              <th></th>
            </tr>
          </tfoot>
        </table>
      </div>
      
      <div class="row between mt-16">
        <button class="btn secondary" id="addItem">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M8 3V13M3 8H13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          افزودن ردیف
        </button>
        <button class="btn secondary" id="clearItems">حذف همه ردیف‌ها</button>
      </div>
    </div>

    <!-- Attachments -->
    <div class="section">
      <h3>پیوست‌ها (عنوان + شماره + تاریخ)</h3>
      <button class="btn secondary" id="addAttachment">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M8 3V13M3 8H13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        افزودن پیوست
      </button>
      <div id="attachmentsArea" class="mt-16"></div>
    </div>

    <!-- Delivery documents required -->
    <div class="section">
      <h3>اسناد موردنیاز تحویل</h3>
      <div id="deliveryDocsChips" class="chips"></div>
      <div class="doc-other">
        <input id="deliveryDocOther" placeholder="سایر...">
        <button class="btn small secondary" id="addDeliveryDoc" type="button">افزودن</button>
      </div>
    </div>

    <!-- Supplier signatories -->
    <div class="section">
      <h3>امضاکنندگان فروشنده (حداکثر ۳ نفر)</h3>
      <div id="supplierSignWrap"></div>
      <button class="btn small secondary" id="addSupplierSign" type="button">+ افزودن امضاکننده</button>
    </div>

    <!-- Dana signers -->
    <div class="section">
      <h3>امضاکنندگان دانا</h3>
      <div class="chips">
        <div class="chip on" id="chipY">غلامرضا یونسی — مدیرعامل و رئیس هیئت مدیره</div>
        <div class="chip" id="chipKaveh">حافظ کاوه — نایب رئیس هیئت مدیره</div>
      </div>
      <div class="hint mt-8">زمانی که ارز «ریال» و مبلغ &lt; ۳۰ میلیارد و کاوه خاموش باشد ⇒ تک‌امضایی (فقط یونسی).</div>
    </div>

    <div class="actions">
      <button class="btn secondary" id="back3">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M5.5 8L9.5 4V12L5.5 8Z" fill="currentColor"/>
        </svg>
        بازگشت
      </button>
      <div class="row">
        <span id="s3status"></span>
        <button class="btn primary" id="go4" data-go-step="4">
          ادامه
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M10.5 8L6.5 4V12L10.5 8Z" fill="currentColor"/>
          </svg>
        </button>
      </div>
    </div>
  </section>

  <!-- Stage 4 -->
  <section id="stage4" class="stage hidden">
    <div class="section">
      <h2>۴. انتخاب بندها (Noban)</h2>
      <div class="progress-bar">
        <div class="progress" style="width: 60%"></div>
      </div>
      <div id="clausesArea"></div>
    </div>
    
    <div class="actions">
      <button class="btn secondary" id="back4">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M5.5 8L9.5 4V12L5.5 8Z" fill="currentColor"/>
        </svg>
        بازگشت
      </button>
      <button class="btn primary" id="goP">
        پیش‌نمایش
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M10.5 8L6.5 4V12L10.5 8Z" fill="currentColor"/>
        </svg>
      </button>
    </div>
  </section>

  <!-- Stage P -->
  <section id="stageP" class="stage hidden">
    <div class="section">
      <h2>۵. پیش‌نمایش / دانلود</h2>
      <div class="progress-bar">
        <div class="progress" style="width: 100%"></div>
      </div>
      <!-- Error message for preview issues -->
      <div id="previewError" class="alert hidden"></div>
      <div class="preview-card">
        <header>پیش‌نمایش Word</header>
        <div id="preview" class="preview-body">
          <div class="welcome">
            <div class="welcome-icon">📄</div>
            <h3>پیش‌نمایش سند</h3>
            <p>پس از کلیک بر روی دکمه "پیش‌نمایش"، محتوای سند در اینجا نمایش داده خواهد شد.</p>
          </div>
        </div>
      </div>
    </div>
    
    <div class="actions">
      <button class="btn secondary" id="back5">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M5.5 8L9.5 4V12L5.5 8Z" fill="currentColor"/>
        </svg>
        بازگشت
      </button>
      <div>
        <span class="hint">بدون سرور می‌توانید فایل الگو را در مرحله ۱ بارگذاری کنید. برای بارگذاری خودکار: <code>template/po-noban.template.docx</code></span>
      </div>
      <div class="row">
        <button class="btn primary" id="downloadDocx">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M8 11L8 3M8 11L5 8M8 11L11 8M3 13H13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          دانلود Word
        </button>
        <button class="btn warn" id="downloadJSON">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M8 11L8 3M8 11L5 8M8 11L11 8M3 13H13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          دانلود JSON
        </button>
        <button class="btn ok" id="saveRecord">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M3 3L13 3L13 13L3 13L3 3Z" stroke="currentColor" stroke-width="2" fill="none"/>
            <path d="M5 8L7.5 10.5L11 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          ذخیره در تاریخچه
        </button>
      </div>
    </div>
  </section>
</main>

<!-- Authentication Modal -->
<div id="authModal" class="modal hidden">
  <div class="modal-content">
    <h3>ورود / ثبت‌نام</h3>
      <!-- Accept plain text usernames like 'guest' as well as email addresses -->
      <input id="authEmail" type="text" placeholder="ایمیل یا نام کاربری">
    <input id="authPassword" type="password" placeholder="کلمه عبور">
    <input id="authDisplayName" type="text" placeholder="نام نمایشی" class="hidden">
    <div class="row">
      <button id="signInSubmit" class="btn primary">ورود</button>
      <button id="signUpSubmit" class="btn secondary">ثبت‌نام</button>
      <button id="authClose" class="btn">بستن</button>
    </div>
    <!-- Additional auth actions: guest login and skip auth -->
    <div class="row mt-8">
      <button id="guestBtn" class="btn secondary">ادامه به صورت مهمان</button>
      <button id="skipAuthBtn" class="btn secondary">فعلاً رد شو</button>
    </div>
    <p id="authError" class="error"></p>
  </div>
</div>

<!-- Guard: ensure auth modal can always be closed and Guest/Skip buttons work even if main script fails -->
<script>
  (function () {
    const $ = (id) => document.getElementById(id);
    const html = document.documentElement;
    const modal = $('authModal');
    const closeBtn = $('authClose');
    const guestBtn = $('guestBtn');
    const skipBtn = $('skipAuthBtn');
    const userEmail = $('userEmail');

    // helper to hide auth modal
    function closeModal() {
      if (modal) modal.classList.add('hidden');
    }
    // expose globally so other scripts can call it
    window.closeAuthModal = closeModal;

    // Check stored flags on boot to apply guest or skip modes before other scripts run
    const skipFlag = sessionStorage.getItem('po_skip_auth') === '1';
    const guestFlag = (localStorage.getItem('po_guest_mode') === '1') ||
      ((window.location.search || '').includes('guest=1')) ||
      (((window.location.hash || '').includes('guest')));
    if (skipFlag) {
      html.classList.add('skip-mode');
      closeModal();
    }
    if (guestFlag) {
      html.classList.add('guest-mode');
      closeModal();
      if (userEmail) userEmail.textContent = 'مهمان';
    }

    // Wire close button, backdrop click, escape key
    if (closeBtn) closeBtn.addEventListener('click', closeModal);
    if (modal) {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });
    }
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modal && !modal.classList.contains('hidden')) {
        closeModal();
      }
    });

    // Guest button: fallback sign-in that works even when Supabase is absent
    if (guestBtn) guestBtn.addEventListener('click', async () => {
      try {
        localStorage.setItem('po_guest_mode', '1');
        sessionStorage.removeItem('po_skip_auth');
        html.classList.add('guest-mode');
        closeModal();
        // Attempt actual guest sign-in if API is available
        try {
          await window.POWizardAPI?.init?.();
          let res = await window.POWizardAPI?.signIn?.({ email: 'guest', password: 'guest' });
          if (res && res.error) {
            // create then sign in
            await window.POWizardAPI?.signUp?.({ email: 'guest', password: 'guest', displayName: 'مهمان' });
            await window.POWizardAPI?.signIn?.({ email: 'guest', password: 'guest' });
          }
        } catch (_) {
          // ignore; offline mode
        }
        if (userEmail) userEmail.textContent = 'مهمان';
      } catch (err) {
        console.error('Guest fallback failed:', err);
      }
    });

    // Skip button: hide modal and disable auth
    if (skipBtn) skipBtn.addEventListener('click', () => {
      sessionStorage.setItem('po_skip_auth', '1');
      localStorage.removeItem('po_guest_mode');
      html.classList.add('skip-mode');
      closeModal();
    });
  })();
</script>

<!-- History Page -->
<section id="historyPage" class="hidden">
  <div class="section">
    <h2>تاریخچه سفارش‌ها</h2>
    <table class="history-table" id="historyTable">
      <thead>
        <tr>
          <th>عنوان</th>
          <th>شماره PO</th>
          <th>وضعیت</th>
          <th>آخرین بروزرسانی</th>
          <th>عملیات</th>
        </tr>
      </thead>
      <tbody id="historyTbody">
        <!-- Rows populated via JS -->
      </tbody>
    </table>
    <p id="historyEmpty" class="hint hidden">هنوز سفارشی ذخیره نشده است.</p>
  </div>
</section>

<!-- Assigned Page -->
<section id="assignedPage" class="hidden">
  <div class="section">
    <h2>ارجاع‌ها</h2>
    <table class="history-table" id="assignedTable">
      <thead>
        <tr>
          <th>عنوان</th>
          <th>شماره PO</th>
          <th>وضعیت</th>
          <th>آخرین بروزرسانی</th>
          <th>عملیات</th>
        </tr>
      </thead>
      <tbody id="assignedTbody">
        <!-- Populated via JS -->
      </tbody>
    </table>
    <p id="assignedEmpty" class="hint hidden">هیچ مورد ارجاعی وجود ندارد.</p>
  </div>
</section>

<script>
/* ---------- theme ---------- */
(() => {
  const dm = document.getElementById('darkMode');
  dm.addEventListener('change', e => {
    document.body.classList.toggle('dark', e.target.checked);
    localStorage.setItem('theme', e.target.checked ? 'dark' : 'light');
  });
  const th = localStorage.getItem('theme');
  if (th === 'dark') {
    dm.checked = true;
    document.body.classList.add('dark');
  }
})();

/* ---------- router ---------- */
function showStage(key) {
  const id = key === 'p' ? 'stageP' : 'stage' + key;
  document.querySelectorAll('.stage').forEach(s => s.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
  const tab = document.querySelector(`.step[data-stage="${key}"]`);
  if (tab) tab.classList.add('active');
}

document.querySelectorAll('.step').forEach(step => {
  step.addEventListener('click', () => {
    showStage(step.dataset.stage);
  });
});

// navigation between stages
document.getElementById('go2').addEventListener('click', () => showStage('2'));
document.getElementById('go3').addEventListener('click', () => showStage('3'));
document.getElementById('go4').addEventListener('click', () => showStage('4'));
document.getElementById('goP').addEventListener('click', () => showStage('p'));
// back buttons
document.getElementById('back2').addEventListener('click', () => showStage('1'));
document.getElementById('back3').addEventListener('click', () => showStage('2'));
document.getElementById('back4').addEventListener('click', () => showStage('3'));
document.getElementById('back5').addEventListener('click', () => showStage('4'));

/* ---------- state ---------- */
function $(id) { return document.getElementById(id) }
const CURRENCY_FA = {IRR: 'ریال', USD: 'دلار آمریکا', EUR: 'یورو', AED: 'درهم'};
const state = {
  template: 'po-noban',
  templateFile: null,
  meta: {
    poNumber: '', issueDate: '', currency: 'IRR', currencyFa: 'ریال', amount: '',
    subject: '', projectName: '', manufacturerName: '', manufacturerCountry: '',
    deliveryDeadlineDays: '', leadtimeTrigger: '', allowBuyerRep: false,
    hasWarranty: false, warrantyMonths: '', fxSettlement: false, fxRateSourceLabel: '',
    offerNumber: '', offerDate: '', hasKaveh: false, isSingleSigner: true, totalNet: 0,
    // new metadata fields
    deadlineType: '',
    incoterms: '',
    calendarType: 'gregorian',
    issueDateJalali: '',
    deliveryDocs: []
  },
  items: [],
  attachments: [],
  // supplier signatories list
  supplierSignatories: [],
  clauses: {
    partial: 'بنا بر صلاحدید و با تأیید موردی خریدار مجاز میباشد',
    delivery: 'درب انبار فروشنده در ............... به صورت ترم تحویل EX-WORK.',
    term: 'خریدار حق فسخ قرارداد را به اختیار و صلاحدید خود خواهد داشت.'
  }
};

/* ---------- persistence (autosave) ---------- */
const KEY = 'noban_v55';
function save() { localStorage.setItem(KEY, JSON.stringify(state)); }
(function load() {
  const raw = localStorage.getItem(KEY);
  if (!raw) return;
  try {
    const s = JSON.parse(raw);
    Object.assign(state.meta, s.meta || {});
    state.items = s.items || [];
    state.attachments = s.attachments || [];
    state.clauses = Object.assign(state.clauses, s.clauses || {});
    state.supplierSignatories = s.supplierSignatories || [];
  } catch {}
})();

/* ---------- template file ---------- */
$('templateFile').addEventListener('change', async (e) => {
  const f = e.target.files?.[0];
  state.templateFile = f ? await f.arrayBuffer() : null;
  save();
});

/* ---------- step-3 bindings ---------- */
['poNumber', 'issueDate', 'subject', 'projectName', 'manufacturerName', 'manufacturerCountry', 
 'deliveryDeadlineDays', 'leadtimeTrigger', 'warrantyMonths', 'fxRateSourceLabel',
 'offerNumber', 'offerDate', 'issueDateJalali', 'deadlineType', 'incoterms'].forEach(id => {
  const el = $(id); 
  if (state.meta[id]) el.value = state.meta[id];
  el.addEventListener('input', e => {
    state.meta[id] = e.target.value;
    computeDerived();
    save();
  });
});

$('currency').value = state.meta.currency;
$('currency').addEventListener('change', e => {
  state.meta.currency = e.target.value;
  computeDerived();
  save();
});

// Safe amount init & bindings
(function () {
  const amountEl = document.getElementById('amount');
  if (!amountEl) return;
  function toWordsFa(n) {
    return (typeof window.numToFaWords === 'function') ? window.numToFaWords(n) : '';
  }
  try {
    const amt = Number(state?.meta?.amount || 0);
    amountEl.value = amt ? amt.toLocaleString('en-US') : '';
  } catch (_) {
    amountEl.value = '';
  }
  amountEl.addEventListener('input', e => {
    const raw = String(e.target.value || '').replace(/,/g, '');
    const num = raw ? parseInt(raw, 10) : 0;
    window.state = window.state || {};
    state.meta = state.meta || {};
    state.meta.amount = Number.isFinite(num) ? num : 0;
    state.meta.amountWords = num ? toWordsFa(num) : '';
    e.target.value = num ? num.toLocaleString('en-US') : '';
    if (typeof computeDerived === 'function') computeDerived();
    if (typeof save === 'function') save();
  });
})();

// set initial values for new select inputs
if ($('deadlineType')) {
  $('deadlineType').value = state.meta.deadlineType || '';
  $('deadlineType').addEventListener('change', e => {
    state.meta.deadlineType = e.target.value;
    save();
  });
}
if ($('incoterms')) {
  $('incoterms').value = state.meta.incoterms || '';
  $('incoterms').addEventListener('change', e => {
    state.meta.incoterms = e.target.value;
    save();
  });
}
if ($('issueDateJalali')) {
  $('issueDateJalali').value = state.meta.issueDateJalali || '';
  $('issueDateJalali').addEventListener('input', e => {
    state.meta.issueDateJalali = e.target.value;
    save();
  });
}

// calendar type toggle between Gregorian and Jalali
if ($('calendarType')) {
  $('calendarType').value = state.meta.calendarType || 'gregorian';
  $('calendarType').addEventListener('change', e => {
    state.meta.calendarType = e.target.value;
    updateCalendarFields();
    save();
  });
  // call once on load
  updateCalendarFields();
}

function updateCalendarFields() {
  const isJalali = state.meta.calendarType === 'jalali';
  const greg = document.querySelector('.cal-greg');
  const jal = document.querySelector('.cal-jalali');
  // Hide or show date fields explicitly via inline styles
  if (greg) greg.style.display = isJalali ? 'none' : '';
  if (jal) jal.style.display = isJalali ? '' : 'none';
}

['allowBuyerRep', 'hasWarranty', 'fxSettlement'].forEach(id => {
  $(id).checked = !!state.meta[id];
  $(id).addEventListener('change', e => {
    state.meta[id] = e.target.checked;
    if (id === 'hasWarranty') updateWarrantyVisibility();
    save();
  });
});

$('warrantyMonths').value = state.meta.warrantyMonths || '';

// hide warranty duration when warranty not selected
function updateWarrantyVisibility() {
  const row = document.getElementById('warrantyMonths')?.parentElement;
  if (!row) return;
  row.style.display = state.meta.hasWarranty ? '' : 'none';
}
updateWarrantyVisibility();

/* ---------- signers ---------- */
$('chipKaveh').classList.toggle('on', !!state.meta.hasKaveh);
$('chipKaveh').addEventListener('click', () => {
  state.meta.hasKaveh = !state.meta.hasKaveh;
  $('chipKaveh').classList.toggle('on', state.meta.hasKaveh);
  computeDerived();
  save();
});

/* ---------- derived ---------- */
function computeDerived() {
  state.meta.currencyFa = CURRENCY_FA[state.meta.currency] || state.meta.currency;
  const n = Number(state.meta.amount || 0);
  state.meta.isSingleSigner = (state.meta.currency === 'IRR' && n < 30000000000 && !state.meta.hasKaveh);
  $('currencyFaPill').textContent = state.meta.currencyFa;
  $('currencyFaTag').textContent = state.meta.currencyFa;
}
computeDerived();

/* ---------- items ---------- */
function recalcTotals() {
  let t = 0;
  state.items.forEach(r => {
    const q = Number(r.qty || 0), p = Number(r.unitPrice || 0);
    r.lineTotal = Math.round(q * p);
    t += r.lineTotal;
  });
  state.meta.totalNet = t;
  $('totalNetText').textContent = (t || 0).toLocaleString('fa-IR');
}

// ---------------- New item table rendering logic ------------------
function buildItemTable() {
  const tb = $('itemsTable').tBodies[0];
  tb.innerHTML = '';                                    // once only
  state.items.forEach((r, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="text-align:center">${i+1}</td>
      <td><input class="item-inp" data-i="${i}" data-k="spec" value="${r.spec||''}" placeholder="مشخصات فنی"></td>
      <td><input class="item-inp" data-i="${i}" data-k="unit" value="${r.unit||''}" placeholder="واحد"></td>
      <td><input class="item-inp" data-i="${i}" data-k="qty" type="number" min="0" step="1" value="${r.qty||''}" placeholder="مقدار"></td>
      <td><input class="item-inp" data-i="${i}" data-k="unitPrice" type="number" min="0" step="1" value="${r.unitPrice||''}" placeholder="قیمت واحد"></td>
      <td style="text-align:left" class="lineTotal">${(r.lineTotal||0).toLocaleString('fa-IR')}</td>
      <td><button class="btn" data-i="${i}" data-act="del">حذف</button></td>`;
    tb.appendChild(tr);
  });
  attachItemListeners();               // wire once
}

function attachItemListeners() {
  document.querySelectorAll('#itemsTable .item-inp').forEach(inp => {
    inp.addEventListener('input', e => {
      const idx = +e.target.dataset.i, key = e.target.dataset.k;
      state.items[idx][key] = e.target.value;
      // update ONLY this row's total
      const row  = e.target.closest('tr');
      const q    = Number(state.items[idx].qty || 0);
      const p    = Number(state.items[idx].unitPrice || 0);
      const total= Math.round(q * p);
      state.items[idx].lineTotal = total;
      row.querySelector('.lineTotal').textContent = total.toLocaleString('fa-IR');
      recalcTotals();   // update footer
      save();
    });
  });
  document.querySelectorAll('#itemsTable [data-act="del"]').forEach(btn => {
    btn.addEventListener('click', e => {
      state.items.splice(+e.target.dataset.i, 1);
      buildItemTable();   // rebuild once
      recalcTotals();
      save();
    });
  });
}

document.getElementById('addItem').addEventListener('click', () => {
  state.items.push({spec:'',unit:'',qty:'',unitPrice:'',lineTotal:0});
  const tb = document.getElementById('itemsTable').tBodies[0];
  const i  = state.items.length - 1;
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td style="text-align:center">${i+1}</td>
    <td><input class="item-inp" data-i="${i}" data-k="spec" value="" placeholder="مشخصات فنی"></td>
    <td><input class="item-inp" data-i="${i}" data-k="unit" value="" placeholder="واحد"></td>
    <td><input class="item-inp" data-i="${i}" data-k="qty" type="number" min="0" step="1" value="" placeholder="مقدار"></td>
    <td><input class="item-inp" data-i="${i}" data-k="unitPrice" type="number" min="0" step="1" value="" placeholder="قیمت واحد"></td>
    <td style="text-align:left" class="lineTotal">۰</td>
    <td><button class="btn" data-i="${i}" data-act="del">حذف</button></td>`;
  tb.appendChild(tr);
  attachItemListeners();   // wire the new row only
  save();
});

document.getElementById('clearItems').addEventListener('click', () => {
  if (!confirm('ردیف‌ها پاک شوند؟')) return;
  state.items = [];
  buildItemTable();
  recalcTotals();
  save();
});

// initialize item table once
buildItemTable();
recalcTotals();

/* ---------- attachments ---------- */
function renderAttachments() {
  const box = $('attachmentsArea');
  box.innerHTML = '';
  
  if (state.attachments.length === 0) {
    box.innerHTML = '<p class="hint">هنوز پیوستی اضافه نشده است.</p>';
    return;
  }
  
  state.attachments.forEach((a, i) => {
    const row = document.createElement('div');
    row.className = 'attachment-row';
    row.innerHTML = `
      <input placeholder="عنوان" value="${a.title || ''}" data-i="${i}" data-k="title">
      <input placeholder="شماره" value="${a.number || ''}" data-i="${i}" data-k="number">
      <input placeholder="تاریخ" value="${a.date || ''}" data-i="${i}" data-k="date">
      <button class="btn" data-act="del" data-i="${i}">حذف</button>`;
    
    row.querySelectorAll('input').forEach(inp => {
      inp.addEventListener('input', e => {
        const idx = +e.target.dataset.i, k = e.target.dataset.k;
        state.attachments[idx][k] = e.target.value;
        save();
      });
    });
    
    row.querySelector('[data-act="del"]').addEventListener('click', e => {
      state.attachments.splice(+e.target.dataset.i, 1);
      renderAttachments();
      save();
    });
    
    box.appendChild(row);
  });
}

$('addAttachment').addEventListener('click', () => {
  state.attachments.push({title: '', number: '', date: ''});
  renderAttachments();
  save();
});
renderAttachments();

/* ---------- delivery docs & supplier signatories ---------- */
const DELIVERY_DOCS = [
  "Invoice", "Packing List", "Bill of Lading", "Insurance Policy",
  "MTC/CoC", "Final Data Book", "Certificate of Origin", "Packing Photos"
];

function renderDeliveryDocs() {
  const wrap = document.getElementById('deliveryDocsChips');
  if (!wrap) return;
  wrap.innerHTML = '';
  // ensure custom docs appear after default options
  const fullList = DELIVERY_DOCS.concat(state.meta.deliveryDocs.filter(x => !DELIVERY_DOCS.includes(x)));
  fullList.forEach(doc => {
    const chip = document.createElement('div');
    chip.className = 'chip';
    const selected = state.meta.deliveryDocs.includes(doc);
    if (selected) chip.classList.add('selected');
    chip.textContent = doc;
    chip.addEventListener('click', () => {
      const idx = state.meta.deliveryDocs.indexOf(doc);
      if (idx > -1) state.meta.deliveryDocs.splice(idx, 1);
      else state.meta.deliveryDocs.push(doc);
      renderDeliveryDocs();
      save();
    });
    wrap.appendChild(chip);
  });
}

if (document.getElementById('addDeliveryDoc')) {
  document.getElementById('addDeliveryDoc').addEventListener('click', () => {
    const inp = document.getElementById('deliveryDocOther');
    const v = (inp.value || '').trim();
    if (!v) return;
    if (!state.meta.deliveryDocs.includes(v)) {
      state.meta.deliveryDocs.push(v);
    }
    inp.value = '';
    renderDeliveryDocs();
    save();
  });
}

function renderSupplierSigns() {
  const wrap = document.getElementById('supplierSignWrap');
  if (!wrap) return;
  wrap.innerHTML = '';
  (state.supplierSignatories || []).forEach((s, i) => {
    const row = document.createElement('div');
    row.innerHTML = `
      <input placeholder="نام" value="${s.name || ''}" data-i="${i}" data-k="name">
      <input placeholder="سمت" value="${s.title || ''}" data-i="${i}" data-k="title">
      <button class="btn small" data-act="del" data-i="${i}">حذف</button>
    `;
    row.querySelectorAll('input').forEach(inp => {
      inp.addEventListener('input', ev => {
        const idx = +ev.target.dataset.i;
        const k = ev.target.dataset.k;
        state.supplierSignatories[idx][k] = ev.target.value;
        save();
      });
    });
    row.querySelector('[data-act="del"]').addEventListener('click', ev => {
      state.supplierSignatories.splice(+ev.target.dataset.i, 1);
      renderSupplierSigns();
      save();
    });
    wrap.appendChild(row);
  });
}

if (document.getElementById('addSupplierSign')) {
  document.getElementById('addSupplierSign').addEventListener('click', e => {
    e.preventDefault();
    if (!state.supplierSignatories) state.supplierSignatories = [];
    if (state.supplierSignatories.length >= 3) return;
    state.supplierSignatories.push({ name: '', title: '' });
    renderSupplierSigns();
    save();
  });
}

// initialize delivery docs and supplier signatories after load
renderDeliveryDocs();
renderSupplierSigns();

/* ---------- clauses ---------- */
const CLAUSES_NOBAN = [
  {
    id: 'partial',
    title: 'حمل به دفعات',
    options: [
      'بنا بر صلاحدید و با تأیید موردی خریدار مجاز میباشد',
      'بنا بر صلاحدید و با تأیید موردی خریدار مجاز نمیباشد'
    ]
  },
  {
    id: 'delivery',
    title: 'مکان و ترم تحویل کالا',
    options: [
      'درب انبار فروشنده در ............... به صورت ترм تحویل EX-WORK.',
      'درب انبار خریدار در اهواز به صورت ترم تحویل DDP. (حسب شمولیت ترم تحویل DDP اینکوترمز 2020، هزینه‌های مربوط به بارگیری، حمل و باراندازی کلیه تجهیزات موضوع قرارداد، به عهده فروشنده می‌باشد و فروشنده متعهد است به هزینه خود نسبت به تأمین و اخذ پوشش بیمه‌ای حمل تجهیزات مذکور اقدام کند. مسئولیت بروز هر نوع حادثه از قبیل آتش‌سوزی، سرقت، تصادف و غیره تا زمان تحویل کالا(های) موضوع قرارداد و تنظیم صورت‌جلسه تحویل بین نماینده خریدار و فروشنده، به عهده فروشنده است.)'
    ]
  },
  {
    id: 'term',
    title: 'حق فسخ',
    options: [
      'خریدار حق فسخ قرارداد را به اختیار و صلاحدید خود خواهد داشت.',
      'خريدار حق دارد به اختیار و صلاحدید خود نسبت به فسخ يا درخواست اصلاح، رفع عیب و یا جایگزینی آن‌ها (مطابق با صلاحدید خریدار) اقدام کند. چنانچه فروشنده ظرف مدت اعلامی خریدار نسبت به اصلاح، رفع عیب و یا جایگزینی کالاها اقدام ننماید، خریدار حق دارد رأساً اقدام نموده و کلیه هزینه‌های مربوطه را به مأخذ اعلامی خریدار به علاوه 15 (پانزده) درصد بالاسری بدون هر گونه تشریفات قضایی و اداری به صلاح‌دید خود از محل کلیه صورت‌حساب‌ها و یا مطالبات فروشنده نزد خریدار به موجب قرارداد حاضر و یا دیگر قراردادها (قبلي يا بعدي)، و یا سایر اموال فروشنده کسر و وصول نماید. فروشنده کلیه خیارات قانونی خود اعم از خیارات مشترک و اختصاصی را از خود سلب و ساقط می‌نماید.'
    ]
  }
];

function renderClauses() {
  const area = $('clausesArea');
  area.innerHTML = '';
  
  CLAUSES_NOBAN.forEach(g => {
    const card = document.createElement('div');
    card.className = 'card';
    card.style.marginBottom = '16px';
    
    const h = document.createElement('h3');
    h.textContent = g.title;
    card.appendChild(h);
    
    g.options.forEach((opt, idx) => {
      const id = g.id + '_' + idx;
      const optionDiv = document.createElement('div');
      optionDiv.className = 'clause-option';
      
      const radio = document.createElement('input');
      radio.type = 'radio';
      radio.name = g.id;
      radio.id = id;
      radio.checked = (state.clauses[g.id] === opt);
      radio.addEventListener('change', () => {
        state.clauses[g.id] = opt;
        save();
      });
      
      const lab = document.createElement('label');
      lab.htmlFor = id;
      lab.textContent = opt;
      
      optionDiv.appendChild(radio);
      optionDiv.appendChild(lab);
      card.appendChild(optionDiv);
    });
    
    area.appendChild(card);
  });
}

/* ---------- validation ---------- */
function validateStage3() {
  const m = state.meta, errs = [];
  // require issueDate (Gregorian) unless calendar is jalali and issueDateJalali provided
  if (!m.issueDate && !(m.calendarType === 'jalali' && m.issueDateJalali)) errs.push('تاریخ صدور');
  if (!(m.subject || '').trim()) errs.push('موضوع');
  if (!(m.projectName || '').trim()) errs.push('پروژه');
  if (!(Number(m.amount) > 0)) errs.push('مبلغ');
  if (state.items.length === 0) errs.push('حداقل یک ردیف کالا');
  if (m.hasWarranty && !(Number(m.warrantyMonths) > 0)) errs.push('مدت گارانتی');
  if (m.fxSettlement && !(m.fxRateSourceLabel || '').trim()) errs.push('برچسب منبع نرخ');
  
  if (errs.length) {
    $('s3status').innerHTML = `<div class="status error">ناقص: ${errs.join('، ')}</div>`;
  } else {
    $('s3status').innerHTML = `<div class="status success">آمادهٔ مرحله ۴</div>`;
  }
  
  return !errs.length;
}

/* ---------- nav ---------- */
document.getElementById('go4').addEventListener('click', () => {
  computeDerived();
  if (!validateStage3()) return;
  renderClauses();
  showStage('4');
});

document.getElementById('goP').addEventListener('click', async () => {
  computeDerived();
  try {
    $('preview').innerHTML = '<div class="welcome"><div class="loading"></div><p>در حال تولید پیش‌نمایش...</p></div>';
    await doPreview();
    showStage('p');
  } catch (err) {
    // Show a friendly error in the preview error box
    const errBox = document.getElementById('previewError');
    if (errBox) {
      errBox.textContent = 'پیش‌نمایش ممکن نشد.\n' + (err.message || 'خطای ناشناخته');
      errBox.classList.remove('hidden');
    } else {
      alert('پیش‌نمایش ممکن نشد: ' + (err.message || 'خطای ناشناخته'));
    }
    console.error(err);
  }
});

/* ---------- docx compose helpers (local-only libs) ---------- */

/* Override composeDocxBlob to rely on local libs with fallback */
async function composeDocxBlob() {
  await waitDocxLibs();
  const ab = await getTemplateArrayBuffer();
  const zip = new PizZip(ab);

  const Docx = getDocxCtor();
  if (!Docx) throw new Error('Docxtemplater در دسترس نیست.');

  let doc;
  try {
    doc = new Docx(zip, {
      paragraphLoop: true,
      linebreaks: true,
      nullGetter() { return ''; },
      delimiters: { start: '{{', end: '}}' },
      errorLogging: true,
    });
  } catch (e) {
    throw new Error('ایجاد Docxtemplater ناموفق: ' + (e?.message || e));
  }

  doc.setData(buildDocxData());
  try {
    doc.render();
  } catch (e) {
    let msg = e?.message || 'خطای ناشناخته';
    if (e?.properties?.errors?.length) {
      msg = e.properties.errors.map(err => {
        const tag = err.properties?.tag || '';
        const expl = err.properties?.explanation || err.message || '';
        return `${tag}: ${expl}`;
      }).join('\n');
    }
    throw new Error(msg);
  }

  return doc.getZip().generate({
    type: 'blob',
    mimeType: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
  });
}

/* Override preview to ensure Mammoth */
async function doPreview() {
  await waitDocxLibs();
  await waitMammoth();
  const blob = await composeDocxBlob();
  const arrayBuffer = await blob.arrayBuffer();
  const { value: html } = await window.mammoth.convertToHtml({ arrayBuffer });
  document.getElementById('preview').innerHTML = html;
}

/* ---------- remaining docx helpers ---------- */
async function fetchArrayBuffer(url) {
  return new Promise((res, rej) => PizZipUtils.getBinaryContent(url, (err, data) => err ? rej(err) : res(data)));
}

async function getTemplateArrayBuffer() {
  // return uploaded template if provided
  if (state.templateFile) return state.templateFile;
  // Determine base path for GitHub Pages (e.g., /dana-po-wizard/)
  const pathname = location.pathname;
  const base = pathname.endsWith('/') ? pathname : pathname.replace(/[^\/]*$/, '');
  const candidates = [
    `${base}template/po-noban.template.docx`,
    `template/po-noban.template.docx`,
    `./template/po-noban.template.docx`
  ];
  let lastErr;
  for (const url of candidates) {
    try {
      return await fetchArrayBuffer(url);
    } catch (e) {
      lastErr = e;
      // continue to next candidate
    }
  }
  throw new Error(`فایل الگو یافت نشد یا در دسترس نیست. مسیرهای امتحان شده:\n${candidates.join('\n')}\nخطا: ${lastErr && lastErr.message}`);
}

function buildDocxData() {
  const meta = state.meta || {};
  const itemsSrc = Array.isArray(state.items) ? state.items : [];
  const attachmentsSrc = Array.isArray(state.attachments) ? state.attachments : [];
  const clauses = state.clauses || {};

  const formatNumber = (value) => {
    if (value === null || value === undefined || value === '') return '';
    const num = Number(value);
    return Number.isFinite(num) ? num.toLocaleString('en-US') : (value || '');
  };

  const leadtimeTriggerText = (meta.leadtimeTrigger || '').toString().trim() || 'انعقاد قرارداد';
  const issueDateOut = (meta.calendarType === 'jalali' && meta.issueDateJalali) ? meta.issueDateJalali : (meta.issueDate || '');
  const fxSettlementText = meta.fxSettlement
    ? `تمامی پرداخت‌های قرارداد به صورت ریالی، براساس نرخ فروش اسکناسِ اعلامی در ${meta.fxRateSourceLabel || ''} در روزِ کاریِ پیش از روزِ پرداخت انجام خواهد پذیرفت.`
    : 'تمامی پرداخت‌های قرارداد به صورت ریالی انجام خواهد شد.';

  const amountNumber = Number(meta.amount);
  const hasAmountNumber = meta.amount !== '' && meta.amount !== null && Number.isFinite(amountNumber);
  const amount = hasAmountNumber ? amountNumber.toLocaleString('en-US') : (meta.amount || '');
  const amountWords = meta.amountWords || (hasAmountNumber ? (window.numToFaWords ? window.numToFaWords(amountNumber) : '') : '');

  return {
    poNumber: meta.poNumber || '',
    issueDate: meta.issueDate || '',
    issueDateOut,
    subject: meta.subject || '',
    projectName: meta.projectName || '',
    manufacturerName: meta.manufacturerName || '',
    manufacturerCountry: meta.manufacturerCountry || '',
    amount,
    amountWords,
    currencyFa: meta.currencyFa || '',
    items: itemsSrc.map((r, i) => ({
      idx: i + 1,
      spec: r?.spec || '',
      unit: r?.unit || '',
      qty: r?.qty || '',
      unitPrice: r?.unitPrice || '',
      lineTotal: formatNumber(r?.lineTotal)
    })),
    totalNet: formatNumber(meta.totalNet ?? meta.amount),
    deliveryDeadlineDays: meta.deliveryDeadlineDays || meta.deliveryDays || '',
    leadtimeTrigger: meta.leadtimeTrigger || '',
    leadtimeTriggerText,
    allowBuyerRep: !!meta.allowBuyerRep,
    hasWarranty: !!meta.hasWarranty,
    warrantyMonths: meta.warrantyMonths || '',
    fxSettlement: !!meta.fxSettlement,
    fxRateSourceLabel: meta.fxRateSourceLabel || '',
    fxSettlementText,
    offerNumber: meta.offerNumber || '',
    offerDate: meta.offerDate || '',
    attachments: attachmentsSrc.map(a => ({
      title: a?.title || '',
      number: a?.number || '',
      date: a?.date || ''
    })),
    deliveryDocs: Array.isArray(meta.deliveryDocs) ? meta.deliveryDocs : [],
    supplierSignatories: Array.isArray(state.supplierSignatories) ? state.supplierSignatories : [],
    partial: clauses.partial,
    delivery: clauses.delivery,
    term: clauses.term,
    hasKaveh: !!meta.hasKaveh,
    isSingleSigner: !!meta.isSingleSigner,
    deadlineType: meta.deadlineType || '',
    incoterms: meta.incoterms || '',
    calendarType: meta.calendarType || 'gregorian',
    issueDateJalali: meta.issueDateJalali || ''
  };
}

/* ---------- preview & download handlers ---------- */
document.getElementById('downloadDocx').addEventListener('click', async () => {
  try {
    const btn = document.getElementById('downloadDocx');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<div class="loading"></div> در حال تولید...';
    btn.disabled = true;
    
    const blob = await composeDocxBlob();
    saveAs(blob, 'po-noban.docx');
    
    btn.innerHTML = originalText;
    btn.disabled = false;
  } catch (err) {
    alert('ساخت Word ناموفق. مسیر/فایل الگو را بررسی کنید.\n' + (err && err.message ? err.message : ''));
    console.error(err);
  }
});

/* ---------- export/import JSON ---------- */
function currentPayload() { 
  return {
    meta: state.meta, 
    items: state.items, 
    attachments: state.attachments, 
    clauses: state.clauses
  }; 
}

document.getElementById('exportJson').addEventListener('click', () => {
  const blob = new Blob([JSON.stringify(currentPayload(), null, 2)], {type: 'application/json'});
  saveAs(blob, 'noban-v55.json');
});

document.getElementById('downloadJSON').addEventListener('click', () => {
  const blob = new Blob([JSON.stringify(currentPayload(), null, 2)], {type: 'application/json'});
  saveAs(blob, 'noban-v55.json');
});

document.getElementById('importJsonBtn').addEventListener('click', () => {
  document.getElementById('importJson').click();
});

document.getElementById('importJson').addEventListener('change', async (e) => {
  const f = e.target.files?.[0]; 
  if (!f) return;
  
  try {
    const txt = await f.text();
    const j = JSON.parse(txt);
    
    Object.assign(state.meta, j.meta || {});
    state.items = j.items || [];
    state.attachments = j.attachments || [];
    state.clauses = Object.assign(state.clauses, j.clauses || {});
    // restore supplier signatories if present in JSON
    state.supplierSignatories = j.supplierSignatories || [];
    
    // reflect UI
    // reflect UI for standard and new metadata fields
    ['poNumber','issueDate','subject','projectName','manufacturerName','manufacturerCountry',
     'deliveryDeadlineDays','leadtimeTrigger','warrantyMonths','fxRateSourceLabel',
     'offerNumber','offerDate','issueDateJalali','deadlineType','incoterms','calendarType'].forEach(id => {
      const el = $(id);
      if (el) el.value = state.meta[id] || '';
    });
    // update currency selector
    $('currency').value = state.meta.currency || 'IRR';
    // update amount display with separators
    $('amount').value = state.meta.amount ? Number(state.meta.amount).toLocaleString('en-US') : '';
    // restore toggle checkboxes
    ['allowBuyerRep','hasWarranty','fxSettlement'].forEach(id => {
      const cb = $(id);
      if (cb) cb.checked = !!state.meta[id];
    });
    // restore Kaveh chip
    $('chipKaveh').classList.toggle('on', !!state.meta.hasKaveh);
    // run calendar, warranty and docs/signs UI updates
    updateCalendarFields();
    updateWarrantyVisibility();
    renderDeliveryDocs && renderDeliveryDocs();
    renderSupplierSigns && renderSupplierSigns();
    computeDerived();
    // rebuild item table and totals after import
    buildItemTable();
    recalcTotals();
    renderAttachments();
    renderClauses();
    save();
    alert('وارد شد.');
  } catch (err) {
    alert('فایل JSON نامعتبر است.');
  }
});

// =====================
// Authentication, History & Notifications
// =====================
(function() {
  // Helper selectors
  const $ = (id) => document.getElementById(id);

  // ---------- number to Persian words helper (shared) ----------
  function numToFaWords(num) {
    // Simple converter for Persian numbers up to billions
    const ones = ['', 'یک', 'دو', 'سه', 'چهار', 'پنج', 'شش', 'هفت', 'هشت', 'نه'];
    const tens = ['', 'ده', 'بیست', 'سی', 'چهل', 'پنجاه', 'شصت', 'هفتاد', 'هشتاد', 'نود'];
    const teens = ['ده', 'یازده', 'دوازده', 'سیزده', 'چهارده', 'پانزده', 'شانزده', 'هفده', 'هجده', 'نوزده'];
    const hundreds = ['', 'صد', 'دویست', 'سیصد', 'چهارصد', 'پانصد', 'ششصد', 'هفتصد', 'هشتصد', 'نهصد'];
    const thousands = ['', 'هزار', 'میلیون', 'میلیارد'];
    if (!num || isNaN(num)) return '';
    let parts = [];
    const digits = num.toString().split('').reverse().join('');
    const chunks = [];
    for (let i = 0; i < digits.length; i += 3) {
      chunks.push(digits.substr(i, 3).split('').reverse().join(''));
    }
    chunks.forEach((chunk, idx) => {
      let n = parseInt(chunk, 10);
      if (n === 0) return;
      let section = [];
      const c = Math.floor(n / 100);
      const t = Math.floor((n % 100) / 10);
      const o = n % 10;
      if (c) section.push(hundreds[c]);
      if (t > 1) {
        section.push(tens[t]);
        if (o) section.push(ones[o]);
      } else if (t === 1) {
        section.push(teens[o]);
      } else if (o) {
        section.push(ones[o]);
      }
      const suffix = thousands[idx] || '';
      if (suffix) section.push(suffix);
      parts.unshift(section.join(' و '));
    });
    return parts.join(' و ');
  }
  // Expose Persian number-to-words helper globally so other modules can reuse it
  window.numToFaWords = numToFaWords;
  const authModal = $('authModal');
  const historyPage = $('historyPage');
  const historyTable = $('historyTbody');
  const historyEmpty = $('historyEmpty');
  const notifBell = $('notifBell');
  const notifCount = $('notifCount');
  const signInBtn = $('signInBtn');
  const signOutBtn = $('signOutBtn');
  const userMenu = $('userMenu');
  const userEmailSpan = $('userEmail');
  const historyNav = $('historyNav');
  const assignedNav = $('assignedNav');
  const assignedPage = $('assignedPage');
  const assignedTable = $('assignedTbody');
  const assignedEmpty = $('assignedEmpty');
  const authEmail = $('authEmail');
  const authPassword = $('authPassword');
  const authDisplayName = $('authDisplayName');
  const signInSubmit = $('signInSubmit');
  const signUpSubmit = $('signUpSubmit');
  const authClose = $('authClose');
  const authError = $('authError');
  const saveRecordBtn = $('saveRecord');

  // Update UI based on auth state
  function updateAuthUI() {
    const user = POWizardAPI.getCurrentUser();
    const skipMode = sessionStorage.getItem('po_skip_auth') === '1';
    const guestMode = document.documentElement.classList.contains('guest-mode');
    // Determine if we should treat as authenticated (guest counts as auth for UI)
    const isAuthed = !!user || guestMode;
    // Update email display: show user email or 'مهمان' for guest
    if (isAuthed) {
      const email = user ? (user.email || (user.user && user.user.email) || '') : 'مهمان';
      userEmailSpan.textContent = email;
      userMenu.classList.remove('hidden');
      signInBtn.classList.add('hidden');
    } else {
      userMenu.classList.add('hidden');
      signInBtn.classList.remove('hidden');
    }
    // Notifications only for real signed in users (not guest)
    if (user && !guestMode) {
      loadNotifications();
    } else {
      notifCount.classList.add('hidden');
    }
    // Disable history and assigned navigation if not a real user (guest or skip or unauth)
    const disableNav = !user || guestMode || skipMode;
    if (historyNav) historyNav.classList.toggle('disabled', disableNav);
    if (assignedNav) assignedNav.classList.toggle('disabled', disableNav);
  }

  // Render history list
  async function renderHistory() {
    if (historyTable) historyTable.innerHTML = '';
    const records = await POWizardAPI.fetchMyRecords();
    if (!records || records.length === 0) {
      if (historyEmpty) historyEmpty.classList.remove('hidden');
      return;
    }
    if (historyEmpty) historyEmpty.classList.add('hidden');
    records.forEach(rec => {
      const tr = document.createElement('tr');
      const updated = rec.updated_at ? new Date(rec.updated_at).toLocaleDateString('fa-IR') : '';
      tr.innerHTML = `<td>${rec.title || ''}</td>` +
                     `<td>${rec.po_number || ''}</td>` +
                     `<td>${statusLabel(rec.status)}</td>` +
                     `<td>${updated}</td>` +
                     `<td class="actions">` +
                     `<button class="btn small primary" data-act="open" data-id="${rec.id}">باز کردن</button>` +
                     `<button class="btn small ok" data-act="download" data-id="${rec.id}">دانلود</button>` +
                     `<button class="btn small warn" data-act="review" data-id="${rec.id}">ارسال بررسی</button>` +
                     `</td>`;
      historyTable.appendChild(tr);
    });
    // attach events
    historyTable.querySelectorAll('button[data-act="open"]').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const id = btn.dataset.id;
        const recs = await POWizardAPI.fetchMyRecords();
        const record = recs.find(r => r.id === id);
        if (!record) return;
        const payload = record.meta_json;
        if (!payload) return;
        Object.assign(state.meta, payload.meta || {});
        state.items = payload.items || [];
        state.attachments = payload.attachments || [];
        state.clauses = Object.assign(state.clauses, payload.clauses || {});
        // reflect UI
        ['poNumber','issueDate','subject','projectName','manufacturerName','manufacturerCountry','deliveryDeadlineDays','leadtimeTrigger','warrantyMonths','fxRateSourceLabel','offerNumber','offerDate'].forEach(id2 => { $(id2).value = state.meta[id2] || ''; });
        $('currency').value = state.meta.currency || 'IRR';
        $('amount').value = state.meta.amount || '';
        ['allowBuyerRep','hasWarranty','fxSettlement'].forEach(id2 => { $(id2).checked = !!state.meta[id2]; });
        $('chipKaveh').classList.toggle('on', !!state.meta.hasKaveh);
        computeDerived();
        buildItemTable(); recalcTotals(); renderAttachments(); renderClauses(); save();
        // close history and show wizard
        historyPage.classList.add('hidden');
        document.querySelector('main.container').classList.remove('hidden');
        document.querySelector('.stepper').classList.remove('hidden');
      });
    });
    historyTable.querySelectorAll('button[data-act="download"]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.dataset.id;
        try {
          const blob = await POWizardAPI.downloadFile(id);
          saveAs(blob, `po-${id}.docx`);
        } catch (err) {
          alert('دانلود نشد');
          console.error(err);
        }
      });
    });
    historyTable.querySelectorAll('button[data-act="review"]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.dataset.id;
        const email = prompt('ایمیل بررسی‌کننده را وارد کنید:');
        if (!email) return;
        try {
          await POWizardAPI.addAssignee(id, email.trim());
          alert('درخواست بررسی ارسال شد.');
          await renderHistory();
        } catch (err) {
          alert(err.message || 'خطا در ارسال');
        }
      });
    });
  }

  // Render records assigned to current user
  async function renderAssigned() {
    if (assignedTable) assignedTable.innerHTML = '';
    const records = await POWizardAPI.fetchAssignedRecords();
    if (!records || records.length === 0) {
      if (assignedEmpty) assignedEmpty.classList.remove('hidden');
      return;
    }
    if (assignedEmpty) assignedEmpty.classList.add('hidden');
    records.forEach(rec => {
      const tr = document.createElement('tr');
      const updated = rec.updated_at ? new Date(rec.updated_at).toLocaleDateString('fa-IR') : '';
      tr.innerHTML = `<td>${rec.title || ''}</td>` +
                     `<td>${rec.po_number || ''}</td>` +
                     `<td>${statusLabel(rec.status)}</td>` +
                     `<td>${updated}</td>` +
                     `<td class="actions">` +
                     `<button class="btn small primary" data-act="open" data-id="${rec.id}">باز کردن</button>` +
                     `<button class="btn small ok" data-act="approve" data-id="${rec.id}">تایید</button>` +
                     `<button class="btn small warn" data-act="request" data-id="${rec.id}">نیاز به اصلاح</button>` +
                     `</td>`;
      assignedTable.appendChild(tr);
    });
    // attach handlers
    assignedTable.querySelectorAll('button[data-act="open"]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.dataset.id;
        const recs = await POWizardAPI.fetchAssignedRecords();
        const record = recs.find(r => r.id === id);
        if (!record) return;
        const payload = record.meta_json;
        if (!payload) return;
        // populate state
        Object.assign(state.meta, payload.meta || {});
        state.items = payload.items || [];
        state.attachments = payload.attachments || [];
        state.clauses = Object.assign(state.clauses, payload.clauses || {});
        // reflect UI
        ['poNumber','issueDate','subject','projectName','manufacturerName','manufacturerCountry','deliveryDeadlineDays','leadtimeTrigger','warrantyMonths','fxRateSourceLabel','offerNumber','offerDate'].forEach(id2 => { $(id2).value = state.meta[id2] || ''; });
        $('currency').value = state.meta.currency || 'IRR';
        $('amount').value = state.meta.amount || '';
        ['allowBuyerRep','hasWarranty','fxSettlement'].forEach(id2 => { $(id2).checked = !!state.meta[id2]; });
        $('chipKaveh').classList.toggle('on', !!state.meta.hasKaveh);
        computeDerived();
        buildItemTable(); recalcTotals(); renderAttachments(); renderClauses(); save();
        // hide assigned page and show wizard
        assignedPage.classList.add('hidden');
        document.querySelector('main.container').classList.remove('hidden');
        document.querySelector('.stepper').classList.remove('hidden');
      });
    });
    assignedTable.querySelectorAll('button[data-act="approve"]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.dataset.id;
        try {
          await POWizardAPI.updateRecordStatus(id, 'approved');
          alert('تایید شد');
          await renderAssigned();
        } catch (err) {
          alert(err.message || 'خطا');
        }
      });
    });
    assignedTable.querySelectorAll('button[data-act="request"]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.dataset.id;
        const note = prompt('دلیل نیاز به اصلاح را وارد کنید (اختیاری):', '');
        try {
          await POWizardAPI.updateRecordStatus(id, 'changes_requested');
          alert('وضعیت به نیاز به اصلاح تغییر یافت');
          await renderAssigned();
        } catch (err) {
          alert(err.message || 'خطا');
        }
      });
    });
  }

  function statusLabel(status) {
    const map = { pending: 'در انتظار', in_review: 'در حال بررسی', changes_requested: 'نیاز به اصلاح', approved: 'تایید شده', finalized: 'نهایی', canceled: 'لغو شده' };
    return map[status] || status || '';
  }

  async function loadNotifications() {
    try {
      const list = await POWizardAPI.fetchNotifications();
      const unread = list.filter(n => !n.read).length;
      if (unread > 0) {
        notifCount.textContent = unread;
        notifCount.classList.remove('hidden');
      } else {
        notifCount.classList.add('hidden');
      }
    } catch (err) {
      console.error(err);
    }
  }

  // Click handlers
  if (signInBtn) {
    signInBtn.addEventListener('click', () => {
      // reset form
      authEmail.value = '';
      authPassword.value = '';
      authDisplayName.value = '';
      authDisplayName.classList.add('hidden');
      authError.textContent = '';
      authModal.classList.remove('hidden');
    });
  }
  if (authClose) authClose.addEventListener('click', () => { authModal.classList.add('hidden'); });

  if (signOutBtn) signOutBtn.addEventListener('click', async () => { await POWizardAPI.signOut(); });

  // Show display name input when clicking sign up
  if (signUpSubmit) signUpSubmit.addEventListener('click', async () => {
    const email = authEmail.value.trim();
    const pass = authPassword.value;
    const name = authDisplayName.value.trim() || email;
    const { error } = await POWizardAPI.signUp({ email, password: pass, displayName: name });
    if (error) {
      authError.textContent = error.message || 'خطا در ثبت‌نام';
    } else {
      authError.textContent = '';
      authModal.classList.add('hidden');
    }
  });

  if (signInSubmit) signInSubmit.addEventListener('click', async () => {
    const email = authEmail.value.trim();
    const pass = authPassword.value;
    const { error } = await POWizardAPI.signIn({ email, password: pass });
    if (error) {
      authError.textContent = error.message || 'خطا در ورود';
    } else {
      authError.textContent = '';
      authModal.classList.add('hidden');
    }
  });

  // --- Guest and Skip login handlers ---
  const guestBtn = $('guestBtn');
  if (guestBtn) {
    guestBtn.addEventListener('click', async () => {
      // Remove skip auth flag
      sessionStorage.removeItem('po_skip_auth');
      // Persist guest mode to localStorage for auto-login on reload
      localStorage.setItem('po_guest_mode', '1');
      try {
        const res = await POWizardAPI.signIn({ email: 'guest', password: 'guest' });
        if (res && res.error) {
          await POWizardAPI.signUp({ email: 'guest', password: 'guest', displayName: 'مهمان' });
          await POWizardAPI.signIn({ email: 'guest', password: 'guest' });
        }
        document.documentElement.classList.add('guest-mode');
        if (typeof window.closeAuthModal === 'function') window.closeAuthModal();
        updateAuthUI();
      } catch (e) {
        console.error('Guest sign-in failed', e);
      }
    });
  }
  const skipBtn = $('skipAuthBtn');
  if (skipBtn) {
    skipBtn.addEventListener('click', () => {
      // Set skip auth flag so modal won't open automatically
      sessionStorage.setItem('po_skip_auth', '1');
      // Clear guest flag
      localStorage.removeItem('po_guest_mode');
      document.documentElement.classList.add('skip-mode');
      if (typeof window.closeAuthModal === 'function') window.closeAuthModal();
      updateAuthUI();
    });
  }

  if (historyNav) {
    historyNav.addEventListener('click', async () => {
      const container = document.querySelector('main.container');
      const stepper = document.querySelector('.stepper');
      if (historyPage.classList.contains('hidden')) {
        if (container) container.classList.add('hidden');
        if (stepper) stepper.classList.add('hidden');
        await renderHistory();
        historyPage.classList.remove('hidden');
      } else {
        historyPage.classList.add('hidden');
        if (container) container.classList.remove('hidden');
        if (stepper) stepper.classList.remove('hidden');
      }
    });
  }

  if (assignedNav) {
    assignedNav.addEventListener('click', async () => {
      const container = document.querySelector('main.container');
      const stepper = document.querySelector('.stepper');
      if (assignedPage.classList.contains('hidden')) {
        if (container) container.classList.add('hidden');
        if (stepper) stepper.classList.add('hidden');
        // load assigned records
        await renderAssigned();
        assignedPage.classList.remove('hidden');
        // hide history page if open
        if (historyPage) historyPage.classList.add('hidden');
      } else {
        assignedPage.classList.add('hidden');
        if (container) container.classList.remove('hidden');
        if (stepper) stepper.classList.remove('hidden');
      }
    });
  }

  if (notifBell) notifBell.addEventListener('click', async () => {
    const list = await POWizardAPI.fetchNotifications();
    if (!list || list.length === 0) {
      alert('هیچ اعلان جدیدی ندارید.');
      return;
    }
    let msg = '';
    list.forEach(n => {
      if (!n.read) {
        msg += (n.type === 'review_request' ? 'درخواست بررسی' : 'پیام') + `: ${n.po_id}` + '\n';
      }
    });
    if (msg) alert(msg);
    // mark all as read
    for (const n of list) {
      if (!n.read) await POWizardAPI.markNotificationRead(n.id);
    }
    notifCount.classList.add('hidden');
  });

  if (saveRecordBtn) {
    saveRecordBtn.addEventListener('click', async () => {
      const user = POWizardAPI.getCurrentUser();
      if (!user) {
        alert('برای ذخیره ابتدا وارد شوید.');
        return;
      }
      try {
        // generate docx blob from current state
        const blob = await composeDocxBlob();
        const data = currentPayload();
        await POWizardAPI.savePoRecord({ meta: data.meta, items: data.items, attachments: data.attachments, clauses: data.clauses, fileBlob: blob });
        alert('سفارش ذخیره شد.');
      } catch (err) {
        console.error(err);
        alert('خطا در ذخیره سفارش.');
      }
    });
  }

  // ----- Stage2 upload inputs: push placeholder attachments -----
  ['uploadMainDoc','uploadEvalDoc','uploadCommissionDoc','uploadVendorDoc','uploadAdditionalDocs'].forEach(fid => {
    const inp = $(fid);
    if (inp) {
      inp.addEventListener('change', (ev) => {
        const files = Array.from(ev.target.files || []);
        files.forEach(f => {
          state.attachments.push({ title: f.name, number: '', date: '' });
        });
        if (typeof renderAttachments === 'function') renderAttachments();
        save();
      });
    }
  });

      // Subscribe to auth state changes
      POWizardAPI.onAuthStateChange(updateAuthUI);

      // Initialise API and apply guest/skip logic on load
      (async () => {
        await POWizardAPI.init();
        let user = POWizardAPI.getCurrentUser();
        // Determine skip or guest flags from storage or URL
        const params = new URLSearchParams(window.location.search);
        const hash = window.location.hash || '';
        const skipFlag = sessionStorage.getItem('po_skip_auth') === '1';
        const guestFlag = (params.get('guest') === '1') || hash.includes('guest') || localStorage.getItem('po_guest_mode') === '1';
        // If user is not signed in
        if (!user) {
          if (guestFlag && window.GUEST_MODE) {
            // attempt to sign in as guest; if fails, sign up then sign in
            try {
              let res = await POWizardAPI.signIn({ email: 'guest', password: 'guest' });
              if (res && res.error) {
                await POWizardAPI.signUp({ email: 'guest', password: 'guest', displayName: 'مهمان' });
                await POWizardAPI.signIn({ email: 'guest', password: 'guest' });
              }
              document.documentElement.classList.add('guest-mode');
              // Hide auth modal if available
              if (typeof window.closeAuthModal === 'function') window.closeAuthModal();
            } catch (e) {
              console.warn('Auto guest sign-in failed:', e);
            }
          } else if (skipFlag) {
            // Skip auth: mark skip mode and hide modal
            document.documentElement.classList.add('skip-mode');
            if (typeof window.closeAuthModal === 'function') window.closeAuthModal();
          }
        } else {
          // Already signed in
          if (user.email === 'guest') {
            document.documentElement.classList.add('guest-mode');
          }
          // hide modal for signed in user
          if (typeof window.closeAuthModal === 'function') window.closeAuthModal();
        }
        updateAuthUI();
      })();
})();
</script>

<!-- ===== Wizard Navigation Guard ===== -->
<script>
  document.addEventListener('click', function (ev) {
    var btn = ev.target.closest && ev.target.closest('[data-go-step]');
    if (!btn) return;
    ev.preventDefault();

    var target = btn.getAttribute('data-go-step');
    if (!target) return;

    if (typeof window.goStep === 'function') {
      window.goStep(target);
      return;
    }

    if (typeof window.showStage === 'function') {
      window.showStage(target);
      return;
    }

    var stages = document.querySelectorAll('.stage');
    stages.forEach(function (el) {
      var stageKey = ((el.dataset && el.dataset.stage) || el.id.replace(/^stage/i, '') || '').toString();
      var current = stageKey.toLowerCase();
      var desired = target.toString().toLowerCase();
      el.classList.toggle('hidden', current !== desired);
    });
  }, true);
</script>


<!-- ===== Docx Preview/Download Robustness Patch (injected) ===== -->
<script>
(function () {
  // Safe DOM helper
  const $ = (id) => document.getElementById(id);

  // Wait for Docxtemplater + PizZip to be present
  async function waitForLibs() {
    const t0 = performance.now();
    while (!(getDocxCtor() && getZipCtor())) {
      if (performance.now() - t0 > 8000) {
        throw new Error('کتابخانه‌ها بارگذاری نشدند');
      }
      await new Promise(r => setTimeout(r, 50));
    }
  }

  // More helpful error presentation (in Persian)
  function showDocxError(err) {
    let msg = 'پیش‌نمایش ممکن نشد.
';
    if (err && err.message) msg += err.message + '
';
    if (err && err.properties && Array.isArray(err.properties.errors)) {
      msg += 'جزئیات برچسب‌ها:
';
      err.properties.errors.forEach((e, idx) => {
        const tag = e.properties && e.properties.tag ? e.properties.tag : '—';
        const exp = e.properties && e.properties.explanation ? e.properties.explanation : (e.message || '—');
        msg += (idx+1) + '. ' + tag + ' — ' + exp + '
';
      });
    }
    const box = $('previewError') || $('preview');
    if (box) box.textContent = msg;
    console.error(err);
  }

  // Base-aware fetch for the template on GitHub Pages
  async function fetchTemplateArrayBuffer() {
    const candidates = [
      // explicit Pages base
      new URL('./template/po-noban.template.docx', location.href).toString(),
      './template/po-noban.template.docx',
      '/dana-po-wizard/template/po-noban.template.docx'
    ];
    let lastErr = null;
    for (const href of candidates) {
      try {
        const res = await fetch(href);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        return await res.arrayBuffer();
      } catch (e) {
        lastErr = e;
      }
    }
    throw new Error('بارگذاری الگو ناکام ماند: ' + (lastErr ? (lastErr.message || lastErr) : 'نامشخص'));
  }

  // Ensure data object contains all tags safely
  function buildDocxDataSafe() {
    try {
      const st = window.state || {};
      const meta = st.meta || {};
      const formatNumber = (value) => {
        if (value === null || value === undefined || value === '') return '';
        const num = Number(value);
        return Number.isFinite(num) ? num.toLocaleString('en-US') : (value || '');
      };

      const items = (Array.isArray(st.items) ? st.items : []).map((r, i) => ({
        idx: (i+1).toString(),
        spec: r.spec || '',
        unit: r.unit || '',
        qty: (r.qty ?? '') + '',
        unitPrice: (r.unitPrice ?? '') + '',
        lineTotal: formatNumber(r.lineTotal)
      }));
      // Derived
      const issueDateOut = (meta.calendarType === 'jalali' && meta.issueDateJalali) ? meta.issueDateJalali : (meta.issueDate || '');
      const leadtimeTriggerText = meta.leadtimeTrigger || 'انعقاد قرارداد';
      const totalNet = formatNumber((st.totals && st.totals.gross) ?? meta.totalNet ?? meta.amount);
      // Arrays used by optional template loops
      const attachments = (Array.isArray(st.attachments) ? st.attachments : []).map(a => ({
        title: a.title || '',
        number: a.number || '',
        date: a.date || ''
      }));
      const deliveryDocs = Array.isArray(meta.deliveryDocs) ? meta.deliveryDocs : [];
      const supplierSignatories = Array.isArray(st.supplierSignatories) ? st.supplierSignatories : [];
      const fxSettlementText = meta.fxSettlement
        ? `تمامی پرداخت‌های قرارداد به صورت ریالی، براساس نرخ فروش اسکناسِ اعلامی در ${meta.fxRateSourceLabel || ''} در روزِ کاریِ پیش از روزِ پرداخت انجام خواهد پذیرفت.`
        : 'تمامی پرداخت‌های قرارداد به صورت ریالی انجام خواهد شد.';
      const clauses = st.clauses || {};
      const amountNumber = Number(meta.amount);
      const hasAmountNumber = meta.amount !== '' && meta.amount !== null && Number.isFinite(amountNumber);
      const amount = hasAmountNumber ? amountNumber.toLocaleString('en-US') : (meta.amount || '');

      // Words
      const amountWords = meta.amountWords || (hasAmountNumber && window.numToFaWords ? window.numToFaWords(amountNumber) : '');

      const out = {
        // Core
        subject: meta.subject || '',
        projectName: meta.projectName || '',
        poNumber: meta.poNumber || '',
        issueDate: meta.issueDate || '',
        issueDateOut,
        calendarType: meta.calendarType || 'gregorian',
        currencyFa: meta.currencyFa || '',
        amount,
        amountWords,
        manufacturerCountry: meta.manufacturerCountry || '',
        manufacturerName: meta.manufacturerName || '',
        partial: clauses.partial,
        delivery: clauses.delivery,
        term: clauses.term,
        // Delivery deadline
        deliveryDeadlineDays: meta.deliveryDeadlineDays || meta.deliveryDays || '',
        leadtimeTrigger: meta.leadtimeTrigger || '',
        leadtimeTriggerText,
        // Warranty
        hasWarranty: !!meta.hasWarranty,
        warrantyMonths: meta.warrantyMonths || '',
        allowBuyerRep: !!meta.allowBuyerRep,
        // FX
        fxSettlement: !!meta.fxSettlement,
        fxRateSourceLabel: meta.fxRateSourceLabel || '',
        fxSettlementText,
        // Totals + items
        totalNet,
        items,
        // Collections
        attachments,
        deliveryDocs,
        supplierSignatories,
        hasKaveh: !!meta.hasKaveh,
        isSingleSigner: !!meta.isSingleSigner,
        // Misc (keep template tolerant)
        incoterms: meta.incoterms || '',
        deadlineType: meta.deadlineType || '',
      };
      return out;
    } catch (e) {
      console.warn('buildDocxDataSafe failed, returning minimal object', e);
      return {};
    }
  }

  // Compose docx with better null handling
  async function composeDocxBlobPatched() {
    await waitForLibs();
    const Docx = getDocxCtor();
    const Zip = getZipCtor();
    if (!Docx) throw new Error('ایجاد Docxtemplater ناموفق: کتابخانه در دسترس نیست');
    if (!Zip) throw new Error('JSZip/PizZip در دسترس نیست');

    const ab = await fetchTemplateArrayBuffer();
    const zip = new Zip(ab);

    const doc = new Docx(zip, {
      paragraphLoop: true,
      linebreaks: true,
      nullGetter() { return ''; }, // tolerate missing fields
      delimiters: { start: '{{', end: '}}' },
      errorLogging: true,
    });

    const data = buildDocxDataSafe();
    doc.setData(data);
    try {
      doc.render();
    } catch (err) {
      showDocxError(err);
      throw err;
    }

    return doc.getZip().generate({
      type: 'blob',
      mimeType: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
    });
  }

  // Hook into existing preview/download if present, else define fresh ones
  window.composeDocxBlob = composeDocxBlobPatched;

  async function doPreviewPatched() {
    try {
      await waitMammoth();
      const blob = await composeDocxBlob();
      const arrayBuffer = await blob.arrayBuffer();
      if (!window.mammoth) throw new Error('کتابخانه Mammoth بارگذاری نشد.');
      const { value: html } = await window.mammoth.convertToHtml({ arrayBuffer });
      const previewEl = $('preview');
      if (previewEl) {
        previewEl.innerHTML = html;
        const errBox = $('previewError');
        if (errBox) errBox.textContent = '';
      }
    } catch (e) {
      showDocxError(e);
    }
  }
  window.doPreview = doPreviewPatched;

  // Safe download
  window.downloadDocx = async function () {
    try {
      const blob = await composeDocxBlob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'PO.docx';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    } catch (e) {
      showDocxError(e);
    }
  };

  // Ensure preview button (if exists) uses patched function
  const prevBtn = document.querySelector('[data-act="preview"], #btnPreview, #previewBtn');
  if (prevBtn) prevBtn.addEventListener('click', (e) => { e.preventDefault(); doPreviewPatched(); });

})();
</script>
<!-- ===== End Docx Patch ===== -->

</body>
</html>
